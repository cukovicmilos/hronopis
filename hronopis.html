<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hronopis - Dnevnik beleški</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#9998;</text></svg>">
<style>
:root {
  --bg: #f5f7fa;
  --bg-card: #ffffff;
  --sidebar-bg: #ffffff;
  --sidebar-text: #6b7280;
  --sidebar-active: #6366f1;
  --sidebar-hover: #f3f4f6;
  --text: #111827;
  --text-light: #6b7280;
  --border: #e5e7eb;
  --primary: #6366f1;
  --primary-hover: #4f46e5;
  --primary-light: #eef2ff;
  --danger: #ef4444;
  --danger-hover: #dc2626;
  --danger-light: #fef2f2;
  --success: #10b981;
  --success-light: #ecfdf5;
  --warning: #f59e0b;
  --warning-light: #fffbeb;
  --neutral-status: #9ca3af;
  --neutral-light: #f3f4f6;
  --info: #8b5cf6;
  --info-light: #ede9fe;
  --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.03);
  --radius: 8px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  overflow: hidden;
}

/* LOGIN SCREEN */
#login-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed;
  inset: 0;
  z-index: 100;
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
}

.login-box {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 48px 40px;
  width: 400px;
  max-width: 90vw;
  box-shadow: var(--shadow-lg);
  text-align: center;
}

.login-box h1 {
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}

.login-box .subtitle {
  color: var(--text-light);
  font-size: 14px;
  margin-bottom: 32px;
}

.login-box .pin-label {
  display: block;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.login-box input[type="password"] {
  width: 100%;
  padding: 14px 16px;
  font-size: 18px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  outline: none;
  transition: border-color var(--transition);
  letter-spacing: 8px;
  text-align: center;
}

.login-box input[type="password"]:focus {
  border-color: var(--primary);
}

.login-box .login-btn {
  width: 100%;
  padding: 14px;
  margin-top: 20px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition);
}

.login-box .login-btn:hover { background: var(--primary-hover); }

.login-error {
  color: var(--danger);
  font-size: 14px;
  margin-top: 12px;
  min-height: 20px;
}

.login-box .first-time {
  margin-top: 0;
  font-size: 13px;
  color: var(--text-light);
}

.login-box .first-time button {
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
}

.login-box .first-time button:hover { text-decoration: underline; }

/* LOGIN: FILE DROP ZONE */
.login-drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 28px 20px;
  margin-bottom: 20px;
  cursor: pointer;
  transition: all var(--transition);
  background: var(--bg);
}

.login-drop-zone:hover,
.login-drop-zone.drag-over {
  border-color: var(--primary);
  background: var(--primary-light);
}

.login-drop-zone .drop-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.login-drop-zone .drop-text {
  font-size: 14px;
  color: var(--text);
  font-weight: 600;
}

.login-drop-zone .drop-hint {
  font-size: 12px;
  color: var(--text-light);
  margin-top: 4px;
}

.login-drop-zone .file-loaded {
  color: var(--success);
  font-weight: 600;
  font-size: 14px;
}

.login-divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 20px 0;
  font-size: 13px;
  color: var(--text-light);
}

.login-divider::before,
.login-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* SETUP SCREEN */
#setup-screen {
  display: none;
  align-items: center;
  justify-content: center;
  position: fixed;
  inset: 0;
  z-index: 101;
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
}

.setup-box {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 48px 40px;
  width: 400px;
  max-width: 90vw;
  box-shadow: var(--shadow-lg);
  text-align: center;
}

.setup-box h2 {
  font-size: 24px;
  margin-bottom: 8px;
}

.setup-box .subtitle {
  color: var(--text-light);
  font-size: 14px;
  margin-bottom: 28px;
}

.setup-box label {
  display: block;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.setup-box input[type="password"] {
  width: 100%;
  padding: 14px 16px;
  font-size: 18px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  outline: none;
  transition: border-color var(--transition);
  letter-spacing: 8px;
  text-align: center;
  margin-bottom: 16px;
}

.setup-box input[type="password"]:focus {
  border-color: var(--primary);
}

.setup-box .setup-btn {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition);
}

.setup-box .setup-btn:hover { background: var(--primary-hover); }

.setup-error {
  color: var(--danger);
  font-size: 14px;
  margin-top: 12px;
  min-height: 20px;
}

.setup-box .back-link {
  margin-top: 20px;
}

.setup-box .back-link button {
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  font-size: 13px;
}

.setup-box .back-link button:hover { color: var(--text); }

/* APP LAYOUT */
#app-screen {
  display: none;
  height: 100vh;
}

.app-layout {
  display: flex;
  height: 100%;
}

/* SIDEBAR */
.sidebar {
  width: 260px;
  min-width: 260px;
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-right: 1px solid var(--border);
}

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-header h2 {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
  cursor: pointer;
}

.sidebar-header h2:hover { opacity: 0.8; }

.sidebar-search {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}

.sidebar-search input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-size: 13px;
  outline: none;
}

.sidebar-search input::placeholder { color: var(--neutral-status); }
.sidebar-search input:focus { border-color: var(--primary); background: var(--bg-card); }

.sidebar-section-label {
  padding: 16px 20px 8px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--neutral-status);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-section-label button {
  background: none;
  border: none;
  color: var(--neutral-status);
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  padding: 2px 4px;
  border-radius: 4px;
}

.sidebar-section-label button:hover { background: var(--sidebar-hover); color: var(--primary); }

.sidebar-classes {
  flex: 1;
  overflow-y: auto;
  padding: 4px 8px;
}

.sidebar-class-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background var(--transition);
  font-size: 14px;
  margin-bottom: 2px;
}

.sidebar-class-item:hover { background: var(--sidebar-hover); }
.sidebar-class-item.active { background: var(--primary-light); color: var(--primary); }

.sidebar-class-item .class-name {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.sidebar-class-item .class-count {
  font-size: 12px;
  background: var(--bg);
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: 8px;
  min-width: 28px;
  text-align: center;
  color: var(--text-light);
}

.sidebar-class-item.active .class-count {
  background: rgba(99,102,241,0.15);
  color: var(--primary);
}

.sidebar-class-actions {
  display: none;
  gap: 2px;
  margin-left: 4px;
}

.sidebar-class-item:hover .sidebar-class-actions { display: flex; }
.sidebar-class-item:hover .class-count { display: none; }

.sidebar-class-actions button {
  background: none;
  border: none;
  color: var(--sidebar-text);
  cursor: pointer;
  padding: 2px 4px;
  font-size: 13px;
  border-radius: 3px;
  opacity: 0.7;
}

.sidebar-class-actions button:hover { opacity: 1; background: var(--border); }

.sidebar-footer {
  padding: 16px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sidebar-footer button {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition);
}

.btn-save {
  background: var(--primary);
  color: #fff;
}

.btn-save:hover { background: var(--primary-hover); }

.btn-save.has-changes {
  animation: pulse-save 2s infinite;
}

@keyframes pulse-save {
  0%, 100% { box-shadow: none; }
  50% { box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.25); }
}

.btn-settings {
  background: var(--bg);
  color: var(--text-light);
}

.btn-settings:hover { background: var(--border); color: var(--text); }

/* MAIN CONTENT */
.main-content {
  flex: 1;
  overflow-y: auto;
  padding: 0;
  display: flex;
  flex-direction: column;
}

/* TOOLBAR */
.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 28px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  min-height: 64px;
}

.toolbar-title {
  font-size: 20px;
  font-weight: 700;
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.toolbar-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* CONTENT AREA */
.content-area {
  flex: 1;
  padding: 24px 28px;
  overflow-y: auto;
}

/* DASHBOARD */
.dashboard-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.stat-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
}

.stat-card .stat-label {
  font-size: 13px;
  color: var(--text-light);
  font-weight: 500;
  margin-bottom: 4px;
}

.stat-card .stat-value {
  font-size: 28px;
  font-weight: 700;
}

.stat-card .stat-icon {
  font-size: 20px;
  margin-bottom: 8px;
}

.dashboard-section {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

.dashboard-section h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}

.top-students-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.top-student-row {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  background: var(--bg);
  border-radius: 6px;
  cursor: pointer;
  transition: background var(--transition);
}

.top-student-row:hover { background: var(--primary-light); }

.top-student-rank {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--primary);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  margin-right: 12px;
  flex-shrink: 0;
}

.top-student-info {
  flex: 1;
}

.top-student-name { font-weight: 600; font-size: 14px; }
.top-student-class { font-size: 12px; color: var(--text-light); }

.top-student-count {
  font-weight: 700;
  font-size: 16px;
  color: var(--primary);
}

.status-distribution {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.status-dist-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: var(--bg);
  border-radius: 6px;
  flex: 1;
  min-width: 150px;
}

.status-dist-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-dist-info .status-dist-label {
  font-size: 13px;
  color: var(--text-light);
}

.status-dist-info .status-dist-count {
  font-size: 22px;
  font-weight: 700;
}

/* STUDENT TABLE */
.student-table-wrap {
  background: var(--bg-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

table.student-table {
  width: 100%;
  border-collapse: collapse;
}

.student-table th {
  text-align: left;
  padding: 14px 16px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  border-bottom: 2px solid var(--border);
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}

.student-table th:hover { color: var(--text); }

.student-table th .sort-arrow {
  margin-left: 4px;
  font-size: 10px;
  opacity: 0.4;
}

.student-table th.sorted .sort-arrow { opacity: 1; color: var(--primary); }

.student-table td {
  padding: 12px 16px;
  font-size: 14px;
  border-bottom: 1px solid var(--border);
}

.student-table tr:last-child td { border-bottom: none; }

.student-table tbody tr {
  cursor: pointer;
  transition: background var(--transition);
}

.student-table tbody tr:hover { background: var(--primary-light); }

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}

.status-badge.good { background: var(--success-light); color: #166534; }
.status-badge.neutral { background: var(--neutral-light); color: #475569; }
.status-badge.bad { background: var(--danger-light); color: #991b1b; }

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-dot.good { background: var(--success); }
.status-dot.neutral { background: var(--neutral-status); }
.status-dot.bad { background: var(--danger); }

.note-count-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 28px;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  background: var(--bg);
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
}

.empty-state .empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 18px;
  color: var(--text);
  margin-bottom: 8px;
}

.empty-state p {
  font-size: 14px;
  margin-bottom: 20px;
}

/* STUDENT PROFILE */
.profile-header {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

.profile-back {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: var(--primary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  margin-bottom: 16px;
  background: none;
  border: none;
}

.profile-back:hover { text-decoration: underline; }

.profile-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
}

.profile-name {
  font-size: 24px;
  font-weight: 700;
}

.profile-meta {
  display: flex;
  gap: 20px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.profile-meta-item {
  font-size: 14px;
  color: var(--text-light);
}

.profile-meta-item strong {
  color: var(--text);
}

.profile-actions {
  display: flex;
  gap: 8px;
}

.profile-notes-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}

.profile-notes-header h3 {
  font-size: 18px;
  font-weight: 600;
}

.notes-filter {
  display: flex;
  gap: 6px;
}

.notes-filter button {
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: var(--bg-card);
  font-size: 13px;
  cursor: pointer;
  transition: all var(--transition);
  color: var(--text-light);
}

.notes-filter button:hover { border-color: var(--primary); color: var(--primary); }
.notes-filter button.active { background: var(--primary); color: #fff; border-color: var(--primary); }

.note-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 16px 20px;
  box-shadow: var(--shadow);
  margin-bottom: 10px;
  border-left: 4px solid var(--border);
  position: relative;
}

.note-card.positive { border-left-color: var(--success); }
.note-card.negative { border-left-color: var(--danger); }
.note-card.info { border-left-color: var(--info); }

.note-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.note-footer {
  margin-top: 8px;
}

.note-date {
  font-size: 13px;
  color: var(--text-light);
  font-weight: 500;
}

.note-type-badge {
  font-size: 12px;
  font-weight: 600;
  padding: 2px 10px;
  border-radius: 12px;
}

.note-type-badge.positive { background: var(--success-light); color: #166534; }
.note-type-badge.negative { background: var(--danger-light); color: #991b1b; }
.note-type-badge.info { background: var(--info-light); color: #3730a3; }

.note-description {
  font-size: 14px;
  line-height: 1.6;
}

.note-actions {
  display: flex;
  position: absolute;
  top: 12px;
  right: 12px;
  gap: 4px;
}

.note-actions button {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 12px;
  color: var(--text-light);
  transition: all var(--transition);
}

.note-actions button:hover { background: var(--border); color: var(--text); }
.note-actions button.delete-btn:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

/* BUTTONS */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}

.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--border); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: var(--danger-hover); }
.btn-sm { padding: 6px 12px; font-size: 13px; }
.btn-ghost { background: none; border: none; color: var(--text-light); padding: 6px 10px; }
.btn-ghost:hover { background: var(--bg); color: var(--text); }

/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 0;
  width: 480px;
  max-width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-light);
  padding: 4px;
  line-height: 1;
}

.modal-close:hover { color: var(--text); }

.modal-body {
  padding: 24px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 24px;
  border-top: 1px solid var(--border);
}

/* FORMS */
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  outline: none;
  transition: border-color var(--transition);
  background: var(--bg-card);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  border-color: var(--primary);
}

.form-group textarea {
  min-height: 80px;
  resize: vertical;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-group .form-hint {
  font-size: 12px;
  color: var(--text-light);
  margin-top: 4px;
}

/* STATUS SELECT */
.status-select {
  display: flex;
  gap: 8px;
}

.status-option {
  flex: 1;
  padding: 10px;
  border: 2px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  font-size: 13px;
  font-weight: 600;
  transition: all var(--transition);
}

.status-option:hover { border-color: var(--text-light); }
.status-option.selected { border-width: 2px; }
.status-option[data-value="good"].selected { border-color: var(--success); background: var(--success-light); color: #166534; }
.status-option[data-value="neutral"].selected { border-color: var(--neutral-status); background: var(--neutral-light); color: #475569; }
.status-option[data-value="bad"].selected { border-color: var(--danger); background: var(--danger-light); color: #991b1b; }

/* NOTE TYPE SELECT */
.type-select {
  display: flex;
  gap: 8px;
}

.type-option {
  flex: 1;
  padding: 10px;
  border: 2px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  font-size: 13px;
  font-weight: 600;
  transition: all var(--transition);
}

.type-option:hover { border-color: var(--text-light); }
.type-option[data-value="positive"].selected { border-color: var(--success); background: var(--success-light); color: #166534; }
.type-option[data-value="negative"].selected { border-color: var(--danger); background: var(--danger-light); color: #991b1b; }
.type-option[data-value="info"].selected { border-color: var(--info); background: var(--info-light); color: #3730a3; }

/* CONFIRM DIALOG */
.confirm-body {
  text-align: center;
  padding: 8px 0;
}

.confirm-body p {
  font-size: 15px;
  margin-bottom: 4px;
}

.confirm-body .confirm-detail {
  font-size: 13px;
  color: var(--text-light);
}

/* SEARCH RESULTS */
.search-results {
  background: var(--bg-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.search-result-item {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background var(--transition);
}

.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover { background: var(--primary-light); }

.search-result-info { flex: 1; }
.search-result-name { font-weight: 600; font-size: 14px; }
.search-result-class { font-size: 13px; color: var(--text-light); }

/* SETTINGS SCREEN */
.settings-section {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

.settings-section h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

/* TOAST */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  padding: 12px 20px;
  border-radius: var(--radius);
  background: var(--text);
  color: #fff;
  font-size: 14px;
  box-shadow: var(--shadow-lg);
  animation: toast-in 0.3s ease;
  max-width: 360px;
}

.toast.success { background: #065f46; }
.toast.error { background: #991b1b; }

@keyframes toast-in {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* HAMBURGER MENU BUTTON */
.sidebar-toggle {
  display: none;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: var(--text);
  padding: 4px 8px;
  border-radius: 4px;
  margin-right: 8px;
  line-height: 1;
  flex-shrink: 0;
}

.sidebar-toggle:hover { background: var(--bg); }

/* SIDEBAR OVERLAY (mobile) */
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 49;
}

.sidebar-overlay.active { display: block; }

/* MOBILE RESPONSIVE */
@media (max-width: 768px) {
  .sidebar-toggle { display: block; }

  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 50;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    box-shadow: none;
    width: 280px;
    min-width: 280px;
  }

  .sidebar.open {
    transform: translateX(0);
    box-shadow: 4px 0 24px rgba(0,0,0,0.15);
  }

  .toolbar {
    padding: 12px 16px;
    min-height: 56px;
  }

  .toolbar-title { font-size: 17px; }

  .content-area {
    padding: 16px;
  }

  /* Dashboard stats: single column */
  .dashboard-stats {
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .stat-card { padding: 14px; }
  .stat-card .stat-value { font-size: 22px; }

  .dashboard-section { padding: 16px; }

  /* Student table: horizontal scroll */
  .student-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .student-table th,
  .student-table td { padding: 10px 12px; white-space: nowrap; }

  /* Profile */
  .profile-header { padding: 16px; }
  .profile-name { font-size: 20px; }
  .profile-top { flex-direction: column; gap: 12px; }
  .profile-actions { width: 100%; }
  .profile-actions .btn { flex: 1; justify-content: center; }

  .profile-notes-header { flex-direction: column; align-items: flex-start; }

  .notes-filter { flex-wrap: wrap; }
  .notes-filter button { padding: 5px 10px; font-size: 12px; }

  /* Note cards */
  .note-card { padding: 12px 14px; }

  /* Modal */
  .modal { width: 100%; border-radius: var(--radius) var(--radius) 0 0; }
  .modal-overlay { padding: 0; align-items: flex-end; }

  /* Forms */
  .form-row { grid-template-columns: 1fr; }

  /* Status/type options */
  .status-select,
  .type-select { flex-wrap: wrap; }
  .status-option,
  .type-option { min-width: calc(50% - 4px); flex: unset; }

  /* Settings */
  .settings-section { padding: 16px; }

  /* Login */
  .login-box { padding: 32px 24px; }

  /* Toasts */
  .toast-container { left: 16px; right: 16px; bottom: 16px; }
  .toast { max-width: 100%; }

  /* Status distribution */
  .status-distribution { flex-direction: column; }
  .status-dist-item { min-width: unset; }
}

@media (max-width: 400px) {
  .dashboard-stats { grid-template-columns: 1fr; }
  .toolbar-actions .btn span { display: none; }
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-box">
    <h1>Hronopis</h1>
    <p class="subtitle">Dnevnik beleški o učenicima</p>

    <!-- File load zone -->
    <div class="login-drop-zone" id="login-drop-zone">
      <div class="drop-icon">&#8681;</div>
      <div class="drop-text" id="drop-text">Učitaj podatke</div>
      <div class="drop-hint" id="drop-hint">Prevucite .json fajl ili kliknite za izbor</div>
      <input type="file" id="file-input" accept=".json" style="display:none">
    </div>

    <!-- PIN field (hidden until file is loaded) -->
    <div id="pin-section" style="display:none;">
      <label class="pin-label">Unesite PIN / lozinku</label>
      <input type="password" id="pin-input" placeholder="••••••" autocomplete="off">
      <button class="login-btn" id="login-btn">Otključaj</button>
    </div>

    <div class="login-error" id="login-error"></div>

    <div class="login-divider">ili</div>

    <div class="first-time">
      Nemate podatke? <button id="goto-setup">Kreirajte novi dnevnik</button>
    </div>
  </div>
</div>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div class="setup-box">
    <h2>Postavite PIN</h2>
    <p class="subtitle">Izaberite PIN ili lozinku za zaštitu podataka</p>
    <label>PIN / Lozinka</label>
    <input type="password" id="setup-pin" placeholder="Unesite PIN" autocomplete="off">
    <label>Potvrdite PIN / Lozinku</label>
    <input type="password" id="setup-pin-confirm" placeholder="Ponovite PIN" autocomplete="off">
    <button class="setup-btn" id="setup-btn">Kreiraj dnevnik</button>
    <div class="setup-error" id="setup-error"></div>
    <div class="back-link">
      <button id="goto-login">&larr; Nazad na prijavu</button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app-screen">
  <div class="app-layout">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2 id="sidebar-title">Hronopis</h2>
      </div>
      <div class="sidebar-search">
        <input type="text" id="global-search" placeholder="Pretraži učenike...">
      </div>
      <div class="sidebar-section-label">
        <span>Razredi</span>
        <button id="add-class-btn" title="Dodaj razred">+</button>
      </div>
      <div class="sidebar-classes" id="sidebar-classes"></div>
      <div class="sidebar-footer">
        <button class="btn-save" id="save-btn">&#9660; Sačuvaj</button>
        <button class="btn-settings" id="settings-btn">&#9881; Podešavanja</button>
      </div>
    </div>

    <!-- SIDEBAR OVERLAY (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="toolbar" id="toolbar">
        <button class="sidebar-toggle" id="sidebar-toggle" title="Meni">&#9776;</button>
        <div class="toolbar-title" id="toolbar-title">Kontrolna tabla</div>
        <div class="toolbar-actions" id="toolbar-actions"></div>
      </div>
      <div class="content-area" id="content-area"></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal">
    <div class="modal-header">
      <h3 id="modal-title"></h3>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<script>
(function() {
'use strict';

// ==================== CRYPTO ====================
const Crypto = {
  async deriveKey(pin, salt) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw', enc.encode(pin), 'PBKDF2', false, ['deriveKey']
    );
    return crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  },

  async encrypt(data, pin) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await this.deriveKey(pin, salt);
    const enc = new TextEncoder();
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      enc.encode(JSON.stringify(data))
    );
    return {
      salt: this.bufToBase64(salt),
      iv: this.bufToBase64(iv),
      data: this.bufToBase64(new Uint8Array(encrypted))
    };
  },

  async decrypt(encObj, pin) {
    const salt = this.base64ToBuf(encObj.salt);
    const iv = this.base64ToBuf(encObj.iv);
    const data = this.base64ToBuf(encObj.data);
    const key = await this.deriveKey(pin, salt);
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv },
      key,
      data
    );
    const dec = new TextDecoder();
    return JSON.parse(dec.decode(decrypted));
  },

  bufToBase64(buf) {
    let binary = '';
    const bytes = buf instanceof Uint8Array ? buf : new Uint8Array(buf);
    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  },

  base64ToBuf(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return bytes;
  }
};

// ==================== STATE ====================
let state = { classes: [], students: [], notes: [] };
let currentPin = '';
let hasUnsavedChanges = false;
let currentView = 'dashboard';
let currentClassId = null;
let currentStudentId = null;
let currentNoteFilter = 'all';
let currentSort = { field: 'lastName', dir: 'asc' };

function todayStamp() {
  const d = new Date();
  const date = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  const time = String(d.getHours()).padStart(2,'0') + String(d.getMinutes()).padStart(2,'0');
  return date + '_' + time;
}

function uuid() {
  return 'xxxx-xxxx-xxxx'.replace(/x/g, () => ((Math.random() * 16) | 0).toString(16));
}

function markChanged() {
  hasUnsavedChanges = true;
  document.getElementById('save-btn').classList.add('has-changes');
}

function markSaved() {
  hasUnsavedChanges = false;
  document.getElementById('save-btn').classList.remove('has-changes');
}

// ==================== CRUD: CLASSES ====================
function addClass(name) {
  const cls = { id: uuid(), name: name.trim(), order: state.classes.length };
  state.classes.push(cls);
  markChanged();
  return cls;
}

function renameClass(id, name) {
  const cls = state.classes.find(c => c.id === id);
  if (cls) { cls.name = name.trim(); markChanged(); }
}

function deleteClass(id) {
  state.students.filter(s => s.classId === id).forEach(s => deleteStudent(s.id));
  state.classes = state.classes.filter(c => c.id !== id);
  markChanged();
}

function getClassById(id) {
  return state.classes.find(c => c.id === id);
}

// ==================== CRUD: STUDENTS ====================
function addStudent(data) {
  const student = {
    id: uuid(),
    classId: data.classId,
    firstName: data.firstName.trim(),
    lastName: data.lastName.trim(),
    registryNumber: data.registryNumber || '',
    parentContact: data.parentContact || '',
    status: data.status || 'neutral',
    createdAt: new Date().toISOString().split('T')[0]
  };
  state.students.push(student);
  markChanged();
  return student;
}

function updateStudent(id, data) {
  const s = state.students.find(st => st.id === id);
  if (!s) return;
  if (data.firstName !== undefined) s.firstName = data.firstName.trim();
  if (data.lastName !== undefined) s.lastName = data.lastName.trim();
  if (data.registryNumber !== undefined) s.registryNumber = data.registryNumber;
  if (data.parentContact !== undefined) s.parentContact = data.parentContact;
  if (data.status !== undefined) s.status = data.status;
  if (data.classId !== undefined) s.classId = data.classId;
  markChanged();
}

function deleteStudent(id) {
  state.notes = state.notes.filter(n => n.studentId !== id);
  state.students = state.students.filter(s => s.id !== id);
  markChanged();
}

function getStudentById(id) {
  return state.students.find(s => s.id === id);
}

function getStudentsByClass(classId) {
  return state.students.filter(s => s.classId === classId);
}

function getStudentNoteCount(studentId) {
  return state.notes.filter(n => n.studentId === studentId).length;
}

// ==================== CRUD: NOTES ====================
function addNote(data) {
  const note = {
    id: uuid(),
    studentId: data.studentId,
    date: data.date,
    description: data.description.trim(),
    type: data.type,
    createdAt: new Date().toISOString()
  };
  state.notes.push(note);
  markChanged();
  return note;
}

function updateNote(id, data) {
  const n = state.notes.find(nt => nt.id === id);
  if (!n) return;
  if (data.date !== undefined) n.date = data.date;
  if (data.description !== undefined) n.description = data.description.trim();
  if (data.type !== undefined) n.type = data.type;
  markChanged();
}

function deleteNote(id) {
  state.notes = state.notes.filter(n => n.id !== id);
  markChanged();
}

function getStudentNotes(studentId) {
  return state.notes
    .filter(n => n.studentId === studentId)
    .sort((a, b) => (b.date + b.createdAt).localeCompare(a.date + a.createdAt));
}

// ==================== SAVE MECHANISM ====================
async function saveFile() {
  try {
    const encResult = await Crypto.encrypt(state, currentPin);
    const json = JSON.stringify({
      encrypted: true,
      salt: encResult.salt,
      iv: encResult.iv,
      data: encResult.data
    });

    downloadFile(json, 'hronopis-podaci-' + todayStamp() + '.json', 'application/json');
    markSaved();
    toast('Podaci sačuvani uspešno!', 'success');
  } catch (e) {
    console.error('Save error:', e);
    toast('Greška pri čuvanju: ' + e.message, 'error');
  }
}

function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ==================== UI: TOAST ====================
function toast(message, type) {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast ' + (type || '');
  t.textContent = message;
  container.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; }, 2500);
  setTimeout(() => container.removeChild(t), 2900);
}

// ==================== UI: MODAL ====================
function openModal(title, bodyHtml, footerHtml) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = bodyHtml;
  document.getElementById('modal-footer').innerHTML = footerHtml;
  document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('active');
}

function confirmDialog(message, detail, onConfirm) {
  openModal('Potvrda', `
    <div class="confirm-body">
      <p>${message}</p>
      ${detail ? `<p class="confirm-detail">${detail}</p>` : ''}
    </div>
  `, `
    <button class="btn btn-secondary" onclick="App.closeModal()">Otkaži</button>
    <button class="btn btn-danger" id="confirm-yes-btn">Obriši</button>
  `);
  document.getElementById('confirm-yes-btn').addEventListener('click', () => {
    closeModal();
    onConfirm();
  });
}

// ==================== UI: SIDEBAR ====================
function openSidebar() {
  document.querySelector('.sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('active');
}
function closeSidebar() {
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('active');
}

function renderSidebar() {
  const container = document.getElementById('sidebar-classes');
  if (state.classes.length === 0) {
    container.innerHTML = '<div style="padding:16px 12px;font-size:13px;color:var(--neutral-status);text-align:center;">Nema razreda.<br>Kliknite + da dodate.</div>';
    return;
  }

  const sorted = [...state.classes].sort((a, b) => a.name.localeCompare(b.name, 'sr'));
  container.innerHTML = sorted.map(cls => {
    const count = getStudentsByClass(cls.id).length;
    const active = currentView === 'class' && currentClassId === cls.id ? ' active' : '';
    return `
      <div class="sidebar-class-item${active}" data-class-id="${cls.id}">
        <span class="class-name">${esc(cls.name)}</span>
        <span class="class-count">${count}</span>
        <div class="sidebar-class-actions">
          <button onclick="event.stopPropagation(); App.showRenameClassModal('${cls.id}')" title="Preimenuj">&#9998;</button>
          <button onclick="event.stopPropagation(); App.showDeleteClassConfirm('${cls.id}')" title="Obriši">&#10005;</button>
        </div>
      </div>
    `;
  }).join('');

  container.querySelectorAll('.sidebar-class-item').forEach(el => {
    el.addEventListener('click', () => {
      currentClassId = el.dataset.classId;
      currentStudentId = null;
      currentView = 'class';
      closeSidebar();
      render();
    });
  });
}

// ==================== UI: MAIN RENDER ====================
function render() {
  renderSidebar();

  switch (currentView) {
    case 'dashboard': renderDashboard(); break;
    case 'class': renderClassView(); break;
    case 'student': renderStudentProfile(); break;
    case 'search': renderSearchResults(); break;
    case 'settings': renderSettings(); break;
  }
}

// ==================== UI: DASHBOARD ====================
function renderDashboard() {
  const toolbar = document.getElementById('toolbar-title');
  toolbar.textContent = 'Kontrolna tabla';
  document.getElementById('toolbar-actions').innerHTML = '';

  const totalStudents = state.students.length;
  const totalNotes = state.notes.length;
  const totalClasses = state.classes.length;

  const statusCounts = { good: 0, neutral: 0, bad: 0 };
  state.students.forEach(s => { statusCounts[s.status] = (statusCounts[s.status] || 0) + 1; });

  // Top students by note count
  const studentNoteCounts = state.students.map(s => ({
    student: s,
    count: getStudentNoteCount(s.id),
    className: (getClassById(s.classId) || {}).name || ''
  })).sort((a, b) => b.count - a.count).slice(0, 5);

  const content = document.getElementById('content-area');
  content.innerHTML = `
    <div class="dashboard-stats">
      <div class="stat-card">
        <div class="stat-icon">&#9670;</div>
        <div class="stat-label">Ukupno razreda</div>
        <div class="stat-value">${totalClasses}</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">&#9679;</div>
        <div class="stat-label">Ukupno učenika</div>
        <div class="stat-value">${totalStudents}</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">&#9998;</div>
        <div class="stat-label">Ukupno beleški</div>
        <div class="stat-value">${totalNotes}</div>
      </div>
    </div>

    <div class="dashboard-section">
      <h3>Distribucija statusa</h3>
      <div class="status-distribution">
        <div class="status-dist-item">
          <div class="status-dist-dot" style="background:var(--success)"></div>
          <div class="status-dist-info">
            <div class="status-dist-label">Dobar</div>
            <div class="status-dist-count">${statusCounts.good}</div>
          </div>
        </div>
        <div class="status-dist-item">
          <div class="status-dist-dot" style="background:var(--neutral-status)"></div>
          <div class="status-dist-info">
            <div class="status-dist-label">Neutralan</div>
            <div class="status-dist-count">${statusCounts.neutral}</div>
          </div>
        </div>
        <div class="status-dist-item">
          <div class="status-dist-dot" style="background:var(--danger)"></div>
          <div class="status-dist-info">
            <div class="status-dist-label">Loš</div>
            <div class="status-dist-count">${statusCounts.bad}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-section">
      <h3>Top 5 učenika po broju beleški</h3>
      <div class="top-students-list" id="top-students-list">
        ${studentNoteCounts.length === 0 ? '<div style="color:var(--text-light);font-size:14px;padding:12px 0;">Nema beleški.</div>' :
          studentNoteCounts.map((item, i) => `
            <div class="top-student-row" data-student-id="${item.student.id}">
              <div class="top-student-rank">${i + 1}</div>
              <div class="top-student-info">
                <div class="top-student-name">${esc(item.student.lastName)} ${esc(item.student.firstName)}</div>
                <div class="top-student-class">${esc(item.className)}</div>
              </div>
              <div class="top-student-count">${item.count}</div>
            </div>
          `).join('')}
      </div>
    </div>
  `;

  content.querySelectorAll('.top-student-row').forEach(el => {
    el.addEventListener('click', () => {
      const s = getStudentById(el.dataset.studentId);
      if (s) {
        currentStudentId = s.id;
        currentClassId = s.classId;
        currentView = 'student';
        render();
      }
    });
  });
}

// ==================== UI: CLASS VIEW ====================
function renderClassView() {
  const cls = getClassById(currentClassId);
  if (!cls) { currentView = 'dashboard'; render(); return; }

  document.getElementById('toolbar-title').textContent = 'Razred: ' + cls.name;
  document.getElementById('toolbar-actions').innerHTML = `
    <button class="btn btn-primary" id="add-student-btn">+ <span>Dodaj učenika</span></button>
  `;
  document.getElementById('add-student-btn').addEventListener('click', () => showStudentModal());

  let students = getStudentsByClass(currentClassId);

  // Sort
  students.sort((a, b) => {
    let va, vb;
    switch (currentSort.field) {
      case 'lastName':
        va = a.lastName.toLowerCase(); vb = b.lastName.toLowerCase();
        break;
      case 'firstName':
        va = a.firstName.toLowerCase(); vb = b.firstName.toLowerCase();
        break;
      case 'registryNumber':
        va = parseInt(a.registryNumber) || 9999; vb = parseInt(b.registryNumber) || 9999;
        break;
      case 'noteCount':
        va = getStudentNoteCount(a.id); vb = getStudentNoteCount(b.id);
        break;
      case 'status':
        const order = { good: 0, neutral: 1, bad: 2 };
        va = order[a.status] ?? 1; vb = order[b.status] ?? 1;
        break;
      default:
        va = a.lastName.toLowerCase(); vb = b.lastName.toLowerCase();
    }
    if (va < vb) return currentSort.dir === 'asc' ? -1 : 1;
    if (va > vb) return currentSort.dir === 'asc' ? 1 : -1;
    return 0;
  });

  const content = document.getElementById('content-area');

  if (students.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">&#9679;</div>
        <h3>Nema učenika u razredu</h3>
        <p>Kliknite "Dodaj učenika" da dodate prvog učenika.</p>
      </div>
    `;
    return;
  }

  const statusLabels = { good: 'Dobar', neutral: 'Neutralan', bad: 'Loš' };
  const sortArrow = (field) => {
    if (currentSort.field === field) {
      return `<span class="sort-arrow">${currentSort.dir === 'asc' ? '&#9650;' : '&#9660;'}</span>`;
    }
    return '<span class="sort-arrow">&#9650;</span>';
  };
  const sortedClass = (field) => currentSort.field === field ? ' sorted' : '';

  content.innerHTML = `
    <div class="student-table-wrap">
      <table class="student-table">
        <thead>
          <tr>
            <th class="${sortedClass('registryNumber')}" data-sort="registryNumber">Br. ${sortArrow('registryNumber')}</th>
            <th class="${sortedClass('lastName')}" data-sort="lastName">Prezime ${sortArrow('lastName')}</th>
            <th class="${sortedClass('firstName')}" data-sort="firstName">Ime ${sortArrow('firstName')}</th>
            <th class="${sortedClass('noteCount')}" data-sort="noteCount">Beleške ${sortArrow('noteCount')}</th>
            <th class="${sortedClass('status')}" data-sort="status">Status ${sortArrow('status')}</th>
          </tr>
        </thead>
        <tbody>
          ${students.map(s => `
            <tr data-student-id="${s.id}">
              <td>${esc(String(s.registryNumber || '-'))}</td>
              <td><strong>${esc(s.lastName)}</strong></td>
              <td>${esc(s.firstName)}</td>
              <td><span class="note-count-badge">${getStudentNoteCount(s.id)}</span></td>
              <td><span class="status-badge ${s.status}"><span class="status-dot ${s.status}"></span>${statusLabels[s.status] || 'Neutralan'}</span></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // Sorting
  content.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.dataset.sort;
      if (currentSort.field === field) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.dir = 'asc';
      }
      render();
    });
  });

  // Click student
  content.querySelectorAll('tr[data-student-id]').forEach(tr => {
    tr.addEventListener('click', () => {
      currentStudentId = tr.dataset.studentId;
      currentView = 'student';
      render();
    });
  });
}

// ==================== UI: STUDENT PROFILE ====================
function renderStudentProfile() {
  const student = getStudentById(currentStudentId);
  if (!student) { currentView = 'class'; render(); return; }

  const cls = getClassById(student.classId);
  const statusLabels = { good: 'Dobar', neutral: 'Neutralan', bad: 'Loš' };

  document.getElementById('toolbar-title').textContent = student.lastName + ' ' + student.firstName;
  document.getElementById('toolbar-actions').innerHTML = `
    <button class="btn btn-primary" id="add-note-btn">+ <span>Nova beleška</span></button>
    <button class="btn btn-secondary" id="edit-student-btn">&#9998; <span>Izmeni</span></button>
    <button class="btn btn-danger btn-sm" id="delete-student-btn">&#10005;</button>
  `;

  document.getElementById('add-note-btn').addEventListener('click', () => showNoteModal());
  document.getElementById('edit-student-btn').addEventListener('click', () => showStudentModal(student));
  document.getElementById('delete-student-btn').addEventListener('click', () => {
    confirmDialog(
      `Obrisati učenika ${student.lastName} ${student.firstName}?`,
      'Sve beleške ovog učenika će takođe biti obrisane.',
      () => {
        deleteStudent(student.id);
        currentStudentId = null;
        currentView = 'class';
        render();
        toast('Učenik obrisan.', 'success');
      }
    );
  });

  let notes = getStudentNotes(student.id);
  if (currentNoteFilter !== 'all') {
    notes = notes.filter(n => n.type === currentNoteFilter);
  }

  const filterBtnClass = (type) => currentNoteFilter === type ? 'active' : '';
  const typeLabels = { positive: 'Pozitivna', negative: 'Negativna', info: 'Info' };

  const content = document.getElementById('content-area');
  content.innerHTML = `
    <div class="profile-header">
      <button class="profile-back" id="profile-back">&larr; Nazad na listu</button>
      <div class="profile-top">
        <div>
          <div class="profile-name">${esc(student.lastName)} ${esc(student.firstName)}</div>
          <div class="profile-meta">
            ${cls ? `<span class="profile-meta-item"><strong>Razred:</strong> ${esc(cls.name)}</span>` : ''}
            ${student.registryNumber ? `<span class="profile-meta-item"><strong>Br. u dnevniku:</strong> ${esc(String(student.registryNumber))}</span>` : ''}
            ${student.parentContact ? `<span class="profile-meta-item"><strong>Kontakt roditelja:</strong> ${esc(student.parentContact)}</span>` : ''}
          </div>
        </div>
        <span class="status-badge ${student.status}"><span class="status-dot ${student.status}"></span>${statusLabels[student.status] || 'Neutralan'}</span>
      </div>
    </div>

    <div class="profile-notes-header">
      <h3>Beleške (${getStudentNoteCount(student.id)})</h3>
      <div class="notes-filter">
        <button class="${filterBtnClass('all')}" data-filter="all">Sve</button>
        <button class="${filterBtnClass('positive')}" data-filter="positive">Pozitivne</button>
        <button class="${filterBtnClass('negative')}" data-filter="negative">Negativne</button>
        <button class="${filterBtnClass('info')}" data-filter="info">Info</button>
      </div>
    </div>

    ${notes.length === 0 ? `
      <div class="empty-state" style="padding:40px 0">
        <div class="empty-icon">&#9998;</div>
        <h3>Nema beleški</h3>
        <p>${currentNoteFilter !== 'all' ? 'Nema beleški ovog tipa.' : 'Kliknite "Nova beleška" da dodate prvu.'}</p>
      </div>
    ` : notes.map(n => `
      <div class="note-card ${n.type}">
        <div class="note-card-header">
          <span class="note-date">${formatDate(n.date)}</span>
        </div>
        <div class="note-description">${esc(n.description)}</div>
        <div class="note-footer">
          <span class="note-type-badge ${n.type}">${typeLabels[n.type] || n.type}</span>
        </div>
        <div class="note-actions">
          <button onclick="App.showNoteModal(App.getNoteById('${n.id}'))">&#9998;</button>
          <button class="delete-btn" onclick="App.showDeleteNoteConfirm('${n.id}')">&#10005;</button>
        </div>
      </div>
    `).join('')}
  `;

  document.getElementById('profile-back').addEventListener('click', () => {
    currentStudentId = null;
    currentView = 'class';
    render();
  });

  content.querySelectorAll('.notes-filter button').forEach(btn => {
    btn.addEventListener('click', () => {
      currentNoteFilter = btn.dataset.filter;
      render();
    });
  });
}

// ==================== UI: SEARCH RESULTS ====================
let searchQuery = '';

function renderSearchResults() {
  document.getElementById('toolbar-title').textContent = 'Rezultati pretrage';
  document.getElementById('toolbar-actions').innerHTML = '';

  const q = searchQuery.toLowerCase().trim();
  const results = state.students.filter(s =>
    s.firstName.toLowerCase().includes(q) ||
    s.lastName.toLowerCase().includes(q) ||
    (s.firstName.toLowerCase() + ' ' + s.lastName.toLowerCase()).includes(q) ||
    (s.lastName.toLowerCase() + ' ' + s.firstName.toLowerCase()).includes(q)
  );

  const content = document.getElementById('content-area');
  if (results.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">&#9906;</div>
        <h3>Nema rezultata</h3>
        <p>Nema učenika koji odgovaraju pretrazi "${esc(searchQuery)}".</p>
      </div>
    `;
    return;
  }

  const statusLabels = { good: 'Dobar', neutral: 'Neutralan', bad: 'Loš' };
  content.innerHTML = `
    <div style="margin-bottom:16px;color:var(--text-light);font-size:14px;">Pronađeno: ${results.length} učenik(a) za "${esc(searchQuery)}"</div>
    <div class="search-results">
      ${results.map(s => {
        const cls = getClassById(s.classId);
        return `
          <div class="search-result-item" data-student-id="${s.id}">
            <div class="search-result-info">
              <div class="search-result-name">${esc(s.lastName)} ${esc(s.firstName)}</div>
              <div class="search-result-class">${cls ? esc(cls.name) : 'Bez razreda'} &middot; Beleške: ${getStudentNoteCount(s.id)}</div>
            </div>
            <span class="status-badge ${s.status}"><span class="status-dot ${s.status}"></span>${statusLabels[s.status]}</span>
          </div>
        `;
      }).join('')}
    </div>
  `;

  content.querySelectorAll('.search-result-item').forEach(el => {
    el.addEventListener('click', () => {
      const s = getStudentById(el.dataset.studentId);
      if (s) {
        currentStudentId = s.id;
        currentClassId = s.classId;
        currentView = 'student';
        currentNoteFilter = 'all';
        render();
      }
    });
  });
}

// ==================== UI: SETTINGS ====================
function renderSettings() {
  document.getElementById('toolbar-title').textContent = 'Podešavanja';
  document.getElementById('toolbar-actions').innerHTML = '';

  const content = document.getElementById('content-area');
  content.innerHTML = `
    <div class="settings-section">
      <h3>Promena PIN-a / Lozinke</h3>
      <div class="form-group">
        <label>Trenutni PIN</label>
        <input type="password" id="settings-old-pin" placeholder="Unesite trenutni PIN">
      </div>
      <div class="form-group">
        <label>Novi PIN</label>
        <input type="password" id="settings-new-pin" placeholder="Unesite novi PIN">
      </div>
      <div class="form-group">
        <label>Potvrdite novi PIN</label>
        <input type="password" id="settings-new-pin-confirm" placeholder="Ponovite novi PIN">
      </div>
      <button class="btn btn-primary" id="change-pin-btn">Promeni PIN</button>
      <div id="pin-change-msg" style="margin-top:12px;font-size:14px;"></div>
    </div>

    <div class="settings-section">
      <h3>Izvoz podataka</h3>
      <p style="font-size:14px;color:var(--text-light);margin-bottom:16px;">Izvezite podatke kao nekriptovan JSON (za backup) ili kao Markdown izveštaj.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-secondary" id="export-json-btn">&#9660; Izvezi podatke (JSON)</button>
        <button class="btn btn-secondary" id="export-md-btn">&#9660; Izvezi podatke (MD)</button>
      </div>
    </div>

    <div class="settings-section">
      <h3>Informacije</h3>
      <p style="font-size:14px;color:var(--text-light);line-height:1.8;">
        <strong>Hronopis</strong> - Dnevnik beleški o učenicima<br>
        Podaci su šifrovani AES-GCM enkripcijom i čuvaju se u zasebnom JSON fajlu.<br>
        HTML aplikacija se nikada ne menja &mdash; podaci se uvoze i izvoze kao .json fajl.<br>
        Razreda: ${state.classes.length} &middot; Učenika: ${state.students.length} &middot; Beleški: ${state.notes.length}
      </p>
    </div>
  `;

  // Export plain JSON
  document.getElementById('export-json-btn').addEventListener('click', () => {
    const json = JSON.stringify(state, null, 2);
    downloadFile(json, 'hronopis-izvoz-' + todayStamp() + '.json', 'application/json');
    toast('Podaci izvezeni kao JSON.', 'success');
  });

  // Export Markdown
  document.getElementById('export-md-btn').addEventListener('click', () => {
    const statusLabels = { good: 'Dobar', neutral: 'Neutralan', bad: 'Loš' };
    const typeLabels = { positive: 'Pozitivna', negative: 'Negativna', info: 'Info' };
    const NL = '\n';
    let md = '# Hronopis - Izveštaj' + NL + NL;
    md += 'Datum izvoza: ' + new Date().toLocaleDateString('sr-Latn-RS') + NL + NL;
    md += 'Razreda: ' + state.classes.length + ' | Učenika: ' + state.students.length + ' | Beleški: ' + state.notes.length + NL + NL;
    md += '---' + NL + NL;

    const sortedClasses = [...state.classes].sort((a, b) => a.name.localeCompare(b.name, 'sr'));
    sortedClasses.forEach(cls => {
      md += '## ' + cls.name + NL + NL;
      const students = getStudentsByClass(cls.id).sort((a, b) => a.lastName.localeCompare(b.lastName, 'sr'));
      if (students.length === 0) {
        md += '_Nema učenika._' + NL + NL;
        return;
      }
      students.forEach(s => {
        md += '### ' + s.lastName + ' ' + s.firstName;
        if (s.registryNumber) md += ' (br. ' + s.registryNumber + ')';
        md += NL;
        md += '- **Status:** ' + (statusLabels[s.status] || s.status) + NL;
        if (s.parentContact) md += '- **Kontakt:** ' + s.parentContact + NL;
        const notes = getStudentNotes(s.id);
        if (notes.length > 0) {
          md += '- **Beleške:** ' + notes.length + NL + NL;
          notes.forEach(n => {
            md += '  - **' + formatDate(n.date) + '** [' + (typeLabels[n.type] || n.type) + '] ' + n.description + NL;
          });
        } else {
          md += '- **Beleške:** 0' + NL;
        }
        md += NL;
      });
    });

    downloadFile(md, 'hronopis-izvestaj-' + todayStamp() + '.md', 'text/markdown');
    toast('Izveštaj izvezen kao Markdown.', 'success');
  });

  document.getElementById('change-pin-btn').addEventListener('click', () => {
    const oldPin = document.getElementById('settings-old-pin').value;
    const newPin = document.getElementById('settings-new-pin').value;
    const confirmPin = document.getElementById('settings-new-pin-confirm').value;
    const msg = document.getElementById('pin-change-msg');

    if (oldPin !== currentPin) {
      msg.innerHTML = '<span style="color:var(--danger)">Pogrešan trenutni PIN.</span>';
      return;
    }
    if (newPin.length < 1) {
      msg.innerHTML = '<span style="color:var(--danger)">Novi PIN ne može biti prazan.</span>';
      return;
    }
    if (newPin !== confirmPin) {
      msg.innerHTML = '<span style="color:var(--danger)">Novi PIN-ovi se ne poklapaju.</span>';
      return;
    }

    currentPin = newPin;
    markChanged();
    msg.innerHTML = '<span style="color:var(--success)">PIN je uspešno promenjen! Sačuvajte fajl da primenite promenu.</span>';
    document.getElementById('settings-old-pin').value = '';
    document.getElementById('settings-new-pin').value = '';
    document.getElementById('settings-new-pin-confirm').value = '';
  });
}

// ==================== MODALS: CLASS ====================
function showAddClassModal() {
  openModal('Dodaj razred', `
    <div class="form-group">
      <label>Naziv razreda</label>
      <input type="text" id="class-name-input" placeholder="npr. 5-1, 7-3" autofocus>
      <div class="form-hint">Unesite oznaku razreda</div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="App.closeModal()">Otkaži</button>
    <button class="btn btn-primary" id="class-save-btn">Dodaj</button>
  `);

  const input = document.getElementById('class-name-input');
  const saveBtn = document.getElementById('class-save-btn');

  const save = () => {
    const name = input.value.trim();
    if (!name) { input.style.borderColor = 'var(--danger)'; return; }
    addClass(name);
    closeModal();
    render();
    toast('Razred "' + name + '" dodat.', 'success');
  };

  saveBtn.addEventListener('click', save);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') save(); });
  setTimeout(() => input.focus(), 100);
}

function showRenameClassModal(classId) {
  const cls = getClassById(classId);
  if (!cls) return;

  openModal('Preimenuj razred', `
    <div class="form-group">
      <label>Novi naziv razreda</label>
      <input type="text" id="class-name-input" value="${esc(cls.name)}" autofocus>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="App.closeModal()">Otkaži</button>
    <button class="btn btn-primary" id="class-save-btn">Sačuvaj</button>
  `);

  const input = document.getElementById('class-name-input');
  const saveBtn = document.getElementById('class-save-btn');

  const save = () => {
    const name = input.value.trim();
    if (!name) { input.style.borderColor = 'var(--danger)'; return; }
    renameClass(classId, name);
    closeModal();
    render();
    toast('Razred preimenovan.', 'success');
  };

  saveBtn.addEventListener('click', save);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') save(); });
  setTimeout(() => { input.focus(); input.select(); }, 100);
}

function showDeleteClassConfirm(classId) {
  const cls = getClassById(classId);
  if (!cls) return;
  const count = getStudentsByClass(classId).length;

  confirmDialog(
    `Obrisati razred "${cls.name}"?`,
    count > 0 ? `Svi učenici (${count}) i njihove beleške će biti obrisani.` : null,
    () => {
      if (currentClassId === classId) { currentClassId = null; currentView = 'dashboard'; }
      deleteClass(classId);
      render();
      toast('Razred "' + cls.name + '" obrisan.', 'success');
    }
  );
}

// ==================== MODALS: STUDENT ====================
function showStudentModal(student) {
  const isEdit = !!student;
  const title = isEdit ? 'Izmeni učenika' : 'Dodaj učenika';

  const classOptions = state.classes.map(c =>
    `<option value="${c.id}" ${(isEdit ? student.classId : currentClassId) === c.id ? 'selected' : ''}>${esc(c.name)}</option>`
  ).join('');

  openModal(title, `
    <div class="form-row">
      <div class="form-group">
        <label>Prezime *</label>
        <input type="text" id="student-last-name" value="${isEdit ? esc(student.lastName) : ''}" placeholder="Prezime">
      </div>
      <div class="form-group">
        <label>Ime *</label>
        <input type="text" id="student-first-name" value="${isEdit ? esc(student.firstName) : ''}" placeholder="Ime">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Razred</label>
        <select id="student-class">${classOptions}</select>
      </div>
      <div class="form-group">
        <label>Broj u dnevniku</label>
        <input type="number" id="student-registry" value="${isEdit ? esc(String(student.registryNumber || '')) : ''}" placeholder="npr. 15" min="1">
      </div>
    </div>
    <div class="form-group">
      <label>Kontakt roditelja</label>
      <input type="text" id="student-contact" value="${isEdit ? esc(student.parentContact || '') : ''}" placeholder="Telefon ili email (opciono)">
    </div>
    <div class="form-group">
      <label>Status</label>
      <div class="status-select" id="student-status-select">
        <div class="status-option ${(!isEdit || student.status === 'good') ? '' : ''}" data-value="good" ${isEdit && student.status === 'good' ? 'class="status-option selected"' : ''}>Dobar</div>
        <div class="status-option" data-value="neutral">Neutralan</div>
        <div class="status-option" data-value="bad">Loš</div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="App.closeModal()">Otkaži</button>
    <button class="btn btn-primary" id="student-save-btn">${isEdit ? 'Sačuvaj' : 'Dodaj'}</button>
  `);

  // Fix status selection rendering
  const statusSelect = document.getElementById('student-status-select');
  const currentStatus = isEdit ? student.status : 'neutral';
  statusSelect.querySelectorAll('.status-option').forEach(opt => {
    if (opt.dataset.value === currentStatus) opt.classList.add('selected');
    opt.addEventListener('click', () => {
      statusSelect.querySelectorAll('.status-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
    });
  });

  document.getElementById('student-save-btn').addEventListener('click', () => {
    const lastName = document.getElementById('student-last-name').value.trim();
    const firstName = document.getElementById('student-first-name').value.trim();
    const classId = document.getElementById('student-class').value;
    const registryNumber = document.getElementById('student-registry').value;
    const parentContact = document.getElementById('student-contact').value.trim();
    const selectedStatus = statusSelect.querySelector('.status-option.selected');
    const status = selectedStatus ? selectedStatus.dataset.value : 'neutral';

    if (!lastName || !firstName) {
      if (!lastName) document.getElementById('student-last-name').style.borderColor = 'var(--danger)';
      if (!firstName) document.getElementById('student-first-name').style.borderColor = 'var(--danger)';
      return;
    }

    if (isEdit) {
      updateStudent(student.id, { firstName, lastName, classId, registryNumber, parentContact, status });
      toast('Učenik ažuriran.', 'success');
    } else {
      addStudent({ firstName, lastName, classId, registryNumber, parentContact, status });
      toast('Učenik dodat.', 'success');
    }

    closeModal();
    render();
  });

  setTimeout(() => document.getElementById('student-last-name').focus(), 100);
}

// ==================== MODALS: NOTE ====================
function showNoteModal(note) {
  const isEdit = !!note;
  const title = isEdit ? 'Izmeni belešku' : 'Nova beleška';
  const today = new Date().toISOString().split('T')[0];

  openModal(title, `
    <div class="form-group">
      <label>Datum</label>
      <input type="date" id="note-date" value="${isEdit ? note.date : today}">
    </div>
    <div class="form-group">
      <label>Tip</label>
      <div class="type-select" id="note-type-select">
        <div class="type-option" data-value="positive">Pozitivna</div>
        <div class="type-option" data-value="negative">Negativna</div>
        <div class="type-option" data-value="info">Info</div>
      </div>
    </div>
    <div class="form-group">
      <label>Opis *</label>
      <textarea id="note-description" placeholder="Opišite događaj ili zapažanje...">${isEdit ? esc(note.description) : ''}</textarea>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="App.closeModal()">Otkaži</button>
    <button class="btn btn-primary" id="note-save-btn">${isEdit ? 'Sačuvaj' : 'Dodaj'}</button>
  `);

  const typeSelect = document.getElementById('note-type-select');
  const currentType = isEdit ? note.type : 'negative';
  typeSelect.querySelectorAll('.type-option').forEach(opt => {
    if (opt.dataset.value === currentType) opt.classList.add('selected');
    opt.addEventListener('click', () => {
      typeSelect.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
    });
  });

  document.getElementById('note-save-btn').addEventListener('click', () => {
    const date = document.getElementById('note-date').value;
    const description = document.getElementById('note-description').value.trim();
    const selectedType = typeSelect.querySelector('.type-option.selected');
    const type = selectedType ? selectedType.dataset.value : 'info';

    if (!description) {
      document.getElementById('note-description').style.borderColor = 'var(--danger)';
      return;
    }
    if (!date) {
      document.getElementById('note-date').style.borderColor = 'var(--danger)';
      return;
    }

    if (isEdit) {
      updateNote(note.id, { date, description, type });
      toast('Beleška ažurirana.', 'success');
    } else {
      addNote({ studentId: currentStudentId, date, description, type });
      toast('Beleška dodata.', 'success');
    }

    closeModal();
    render();
  });

  setTimeout(() => document.getElementById('note-description').focus(), 100);
}

function showDeleteNoteConfirm(noteId) {
  confirmDialog('Obrisati ovu belešku?', null, () => {
    deleteNote(noteId);
    render();
    toast('Beleška obrisana.', 'success');
  });
}

function getNoteById(id) {
  return state.notes.find(n => n.id === id);
}

// ==================== HELPERS ====================
function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('-');
  if (parts.length === 3) return parts[2] + '.' + parts[1] + '.' + parts[0] + '.';
  return dateStr;
}

// ==================== INIT ====================
function init() {
  const loginScreen = document.getElementById('login-screen');
  const setupScreen = document.getElementById('setup-screen');
  const appScreen = document.getElementById('app-screen');

  // Loaded file data (kept in memory until PIN is entered)
  let loadedFileData = null;

  const dropZone = document.getElementById('login-drop-zone');
  const fileInput = document.getElementById('file-input');
  const pinSection = document.getElementById('pin-section');
  const dropText = document.getElementById('drop-text');
  const dropHint = document.getElementById('drop-hint');

  function handleFileSelect(file) {
    if (!file) return;
    if (!file.name.endsWith('.json')) {
      document.getElementById('login-error').textContent = 'Izaberite .json fajl.';
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        if (!parsed.encrypted || !parsed.data || !parsed.salt || !parsed.iv) {
          document.getElementById('login-error').textContent = 'Fajl nije validan Hronopis fajl sa podacima.';
          return;
        }
        loadedFileData = parsed;
        document.getElementById('login-error').textContent = '';
        dropZone.querySelector('.drop-icon').textContent = '\u2713';
        dropText.textContent = file.name;
        dropText.classList.add('file-loaded');
        dropHint.textContent = 'Fajl učitan. Unesite PIN za otključavanje.';
        pinSection.style.display = '';
        setTimeout(() => document.getElementById('pin-input').focus(), 100);
      } catch (err) {
        document.getElementById('login-error').textContent = 'Fajl nije ispravan JSON.';
      }
    };
    reader.readAsText(file);
  }

  // Click to select file
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
  });

  // Drag and drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
  });

  // Also allow drag-drop on the whole login screen
  loginScreen.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });
  loginScreen.addEventListener('dragleave', (e) => {
    if (!loginScreen.contains(e.relatedTarget)) dropZone.classList.remove('drag-over');
  });
  loginScreen.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
  });

  // Login (decrypt loaded file)
  const loginAction = async () => {
    const pin = document.getElementById('pin-input').value;
    if (!pin) {
      document.getElementById('login-error').textContent = 'Unesite PIN.';
      return;
    }

    if (!loadedFileData) {
      document.getElementById('login-error').textContent = 'Prvo učitajte fajl sa podacima.';
      return;
    }

    try {
      document.getElementById('login-btn').textContent = 'Otključavanje...';
      document.getElementById('login-btn').disabled = true;
      state = await Crypto.decrypt(loadedFileData, pin);
      currentPin = pin;
      loadedFileData = null;
      loginScreen.style.display = 'none';
      appScreen.style.display = 'block';
      document.body.style.overflow = '';
      currentView = 'dashboard';
      render();
    } catch (e) {
      document.getElementById('login-error').textContent = 'Pogrešan PIN ili oštećeni podaci.';
      document.getElementById('login-btn').textContent = 'Otključaj';
      document.getElementById('login-btn').disabled = false;
    }
  };

  document.getElementById('login-btn').addEventListener('click', loginAction);
  document.getElementById('pin-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') loginAction();
  });

  // Setup (new diary)
  document.getElementById('goto-setup').addEventListener('click', () => {
    loginScreen.style.display = 'none';
    setupScreen.style.display = 'flex';
    setTimeout(() => document.getElementById('setup-pin').focus(), 100);
  });

  document.getElementById('goto-login').addEventListener('click', () => {
    setupScreen.style.display = 'none';
    loginScreen.style.display = 'flex';
  });

  const setupAction = async () => {
    const pin = document.getElementById('setup-pin').value;
    const pinConfirm = document.getElementById('setup-pin-confirm').value;

    if (!pin) {
      document.getElementById('setup-error').textContent = 'Unesite PIN.';
      return;
    }
    if (pin !== pinConfirm) {
      document.getElementById('setup-error').textContent = 'PIN-ovi se ne poklapaju.';
      return;
    }

    currentPin = pin;
    state = { classes: [], students: [], notes: [] };
    setupScreen.style.display = 'none';
    appScreen.style.display = 'block';
    document.body.style.overflow = '';
    currentView = 'dashboard';
    markChanged();
    render();
    toast('Dnevnik kreiran! Ne zaboravite da sačuvate.', 'success');
  };

  document.getElementById('setup-btn').addEventListener('click', setupAction);
  document.getElementById('setup-pin-confirm').addEventListener('keydown', e => {
    if (e.key === 'Enter') setupAction();
  });

  // Mobile sidebar toggle
  const sidebarToggle = document.getElementById('sidebar-toggle');

  sidebarToggle.addEventListener('click', () => {
    document.querySelector('.sidebar').classList.contains('open') ? closeSidebar() : openSidebar();
  });
  document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

  // Sidebar title -> dashboard
  document.getElementById('sidebar-title').addEventListener('click', () => {
    currentView = 'dashboard';
    currentClassId = null;
    currentStudentId = null;
    closeSidebar();
    render();
  });

  // Add class button
  document.getElementById('add-class-btn').addEventListener('click', showAddClassModal);

  // Save button
  document.getElementById('save-btn').addEventListener('click', saveFile);

  // Settings button
  document.getElementById('settings-btn').addEventListener('click', () => {
    closeSidebar();
    currentView = 'settings';
    render();
  });

  // Global search
  let searchTimeout;
  document.getElementById('global-search').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const q = e.target.value.trim();
    if (q.length === 0) {
      if (currentView === 'search') {
        currentView = 'dashboard';
        render();
      }
      return;
    }
    searchTimeout = setTimeout(() => {
      searchQuery = q;
      currentView = 'search';
      render();
    }, 300);
  });

  // Modal close
  document.getElementById('modal-close').addEventListener('click', closeModal);
  document.getElementById('modal-overlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-overlay')) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  // Unsaved changes warning
  window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
      e.preventDefault();
      e.returnValue = 'Imate nesačuvane promene. Da li ste sigurni da želite da napustite stranicu?';
    }
  });
}

// Expose API for inline event handlers
window.App = {
  closeModal,
  showRenameClassModal,
  showDeleteClassConfirm,
  showNoteModal,
  showDeleteNoteConfirm,
  getNoteById,
};

// Start
init();

})();
</script>
</body>
</html>
